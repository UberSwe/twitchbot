<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <style type="text/css">
        body {
            background-color: #232946;
            color: #B8C1EC;
        }
        h1, h2, h3, h4, h5, h6 {
            color: #FFFFFE;
        }
        button {
            color: #232946;
            background-color: #EEBBC3;
        }
        input[type="text"], textarea {
            background-color: #d4d8f0;
            color: #232946;
        }
        .btn-primary {
            color: #232946;
            background-color: #B8C1EC;
        }
        .btn-danger {
            color: #232946;
            background-color: #EEBBC3;
        }
        .messages {
            height: 350px;
            overflow-y: auto;
            border-radius: 4px;
            border-style: solid;
            border-color: lightblue;
            padding: 3px;
            background-color: #d4d8f0;
            color: #232946;
        }
        .cmd {
            border-radius: 4px;
            border-style: solid;
            border-color: lightblue;
            padding: 3px;
            margin-top: 5px;
            background-color: #d4d8f0;
            color: #232946;
        }
        .top-buffer { margin-top:20px; }
    </style>

    <title>Bots by UberSwe</title>
</head>
<body>
<div class="container">

    <div class="alert alert-success" role="alert">
        You're now logged in, connect your bot to a channel and add any custom commands. The bot will only send messages if it's a mod of a channel.
    </div>
    <div class="alert alert-warning" role="alert">
        This bot is in Alpha, some things might not work as expected and the bot may stop working. Any changes you make on the page could be erased with breaking changes.
    </div>

    <div class="row">
        <div class="col-sm">
            <form>
                <div class="form-group">
                    <label for="channel">Connect to a channel</label>
                    <input type="text" class="form-control" id="channel" name="channel"
                           placeholder="Enter a channel name">
                </div>
                <button type="submit" class="btn btn-primary" id="connect">Connect</button>
                <button type="submit" class="btn btn-danger" id="disconnect" hidden>Disconnect</button>
            </form>
        </div>
        <div class="col-sm">

            <div id="messages" class="messages">
                <div class="message">
                    Chat feed appears here when you connect to a channel.
                </div>
            </div>
        </div>
    </div>
    <div class="row top-buffer">
        <div class="col-sm">
            <h2>Variables</h2>
            <p><b>user</b> - If your command specified a user such as <b>@uberswe</b>.</p>
            <p><b>lasthost</b> - This will be the user who last hosted your channel.</p>
            <p><b>lastraid</b> - This will be the user who last raided your channel.</p>
            <p><b>lasthostraid</b> - This will be the user who last hosted or raided your channel.</p>
        </div>
        <div class="col-sm">
            <h2>Commands</h2>
            <form>
                <div class="form-group">
                    <label for="command">Create a command</label>
                    <input type="text" class="form-control" id="command" name="command"
                           placeholder="!so {user}">
                    <label for="commandtext">Message text</label>
                    <input type="text" class="form-control" id="commandtext" name="commandtext"
                           placeholder="Check out and follow @{user}! https://twitch.tv/{user}">
                </div>
                <button type="submit" class="btn btn-primary" id="createcommand">Create</button>
                <div class="commands" id="commands">
                    <div class="cmd">
                        <p><b>!so {user}</b></p>
                        <p>Check out and follow @{user}! https://twitch.tv/{user}</p>
                        <button type="submit" class="btn btn-danger" id="removecommand">Remove</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

</div>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
<script>
    const messages = document.getElementById ('messages');

    let ws = new WebSocket ('wss://' + window.location.host + '/ws');
    if (location.protocol !== 'https:')
    {
        ws = new WebSocket ('ws://' + window.location.host + '/ws');
    }
    ws.addEventListener ('message', function (e) {
        let msg = JSON.parse (e.data);
        console.log(msg);
        // {
        //    "key":"notice",
        //    "private_message":{"User":{"ID":"23198345","Name":"im_slaughter","DisplayName":"Im_Slaughter","Color":"#1E90FF","Badges":{"subscriber":3}},"Raw":"@badge-info=subscriber/5;badges=subscriber/3;color=#1E90FF;display-name=Im_Slaughter;emotes=;flags=;id=45b903a3-369d-4bcf-b4dd-6719596c4b9a;mod=0;room-id=158130480;subscriber=1;tmi-sent-ts=1577843394570;turbo=0;user-id=23198345;user-type= :im_slaughter!im_slaughter@im_slaughter.tmi.twitch.tv PRIVMSG #tweak :@mario_espo i swear this event is gonna make this game explode in popularity","Type":1,"RawType":"PRIVMSG","Tags":{"badge-info":"subscriber/5","badges":"subscriber/3","color":"#1E90FF","display-name":"Im_Slaughter","emotes":"","flags":"","id":"45b903a3-369d-4bcf-b4dd-6719596c4b9a","mod":"0","room-id":"158130480","subscriber":"1","tmi-sent-ts":"1577843394570","turbo":"0","user-id":"23198345","user-type":""},"Message":"@mario_espo i swear this event is gonna make this game explode in popularity","Channel":"tweak","RoomID":"158130480","ID":"45b903a3-369d-4bcf-b4dd-6719596c4b9a","Time":"2020-01-01T02:49:54.57+01:00","Emotes":null,"Bits":0,"Action":false}}
        if (msg.key === "message" | msg.key === "notice") {
            messageReceive (msg.private_message);
        } else if (msg.key === "channel") {
            channelReceive (msg.channel);
        } else if (msg.key === "endchannel") {
            channelEndReceive (msg.value);
        } else if (msg.key === "addcommand") {
            channelEndReceive (msg.value);
        }  else if (msg.key === "removecommand") {
            channelEndReceive (msg.value);
        }  else {
            console.log (msg)
        }
    });

    ws.addEventListener ('open', function (e) {
        console.log("socket open")
    });

    ws.addEventListener ('close', function (e) {
        console.log ("socket closed")
    });

    document.getElementById ("connect").addEventListener ('click', function (e) {
        e.preventDefault ();
        document.getElementById ("connect").hidden = true;
        document.getElementById ("disconnect").hidden = false;
        ws.send (JSON.stringify ({key: "connect", channel: document.getElementById("channel").value}));
    });

    document.getElementById ("disconnect").addEventListener ('click', function (e) {
        e.preventDefault ();
        document.getElementById ("connect").hidden = false;
        document.getElementById ("disconnect").hidden = true;
        ws.send (JSON.stringify ({key: "disconnect", channel: document.getElementById("channel").value}));
    });

    document.getElementById ("createcommand").addEventListener ('click', function (e) {
        e.preventDefault ();
        let jsonmsg = JSON.stringify ({
            key: "createcommand",
            command: document.getElementById ("command").value,
            text: document.getElementById ("commandtext").value
        })
        console.log(jsonmsg)
        ws.send (jsonmsg);
    });

    document.getElementById ("removecommand").addEventListener ('click', function (e) {
        e.preventDefault ();
        let cmd = e.currentTarget.parentNode.querySelector('p').innerText;
        ws.send (JSON.stringify ({key: "removecommand", value: cmd}));
    });

    function appendMessage(m, c) {
        var message = document.createElement ('div');
        message.className = c;
        message.innerHTML = m;
        messages.appendChild (message);
    }

    function receiveMessage(message, className) {
        // Prior to getting your messages.
        let shouldScroll = messages.scrollTop + messages.clientHeight === messages.scrollHeight;
        /*
         * Get your messages, we'll just simulate it by appending a new one syncronously.
         */
        appendMessage (message, className);
        // After getting your messages.
        if (!shouldScroll) {
            scrollToBottom ();
        }
    }

    function messageReceive(obj) {
        if (obj.User.Color !== "") {
            receiveMessage ("<b><span style=\"color:" + obj.User.Color + "\">" + obj.User.DisplayName + ":</span></b> " + obj.Message, 'message')
        } else {
            receiveMessage ("<b>" + obj.User.DisplayName + ":</b> " + obj.Message, 'message')
        }
    }

    function noticeReceive(message) {
        receiveMessage (message, 'notice')
    }

    function channelReceive(message) {
        receiveMessage ("Connected to channel " + message, 'channel')
    }

    function channelEndReceive(message) {
        receiveMessage ("Disconnected from channel " + message, 'channel')
    }

    function scrollToBottom() {
        messages.scrollTop = messages.scrollHeight;
    }

    scrollToBottom ();

</script>


</body>
</html>